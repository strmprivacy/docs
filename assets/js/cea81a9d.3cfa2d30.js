"use strict";(self.webpackChunkend_user_docs=self.webpackChunkend_user_docs||[]).push([[1527],{3905:(e,t,a)=>{a.d(t,{Zo:()=>c,kt:()=>h});var n=a(7294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function o(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?o(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},o=Object.keys(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var s=n.createContext({}),p=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},c=function(e){var t=p(e.components);return n.createElement(s.Provider,{value:t},e.children)},m="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,o=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),m=p(a),d=r,h=m["".concat(s,".").concat(d)]||m[d]||u[d]||o;return a?n.createElement(h,i(i({ref:t},c),{},{components:a})):n.createElement(h,i({ref:t},c))}));function h(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=a.length,i=new Array(o);i[0]=d;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[m]="string"==typeof e?e:r,i[1]=l;for(var p=2;p<o;p++)i[p]=a[p];return n.createElement.apply(null,i)}return n.createElement.apply(null,a)}d.displayName="MDXCreateElement"},8949:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>u,frontMatter:()=>o,metadata:()=>l,toc:()=>p});var n=a(7462),r=(a(7294),a(3905));const o={title:"Pay As You Go (PAYG)",hide_table_of_contents:!1,description:"Billing via AWS"},i=void 0,l={unversionedId:"quickstart/ccd/aws-marketplace/payg",id:"quickstart/ccd/aws-marketplace/payg",title:"Pay As You Go (PAYG)",description:"Billing via AWS",source:"@site/docs/03-quickstart/05-ccd/03-aws-marketplace/02-payg.md",sourceDirName:"03-quickstart/05-ccd/03-aws-marketplace",slug:"/quickstart/ccd/aws-marketplace/payg",permalink:"/docs/latest/quickstart/ccd/aws-marketplace/payg",draft:!1,tags:[],version:"current",sidebarPosition:2,frontMatter:{title:"Pay As You Go (PAYG)",hide_table_of_contents:!1,description:"Billing via AWS"},sidebar:"docs",previous:{title:"Bring Your Own License (BYOL)",permalink:"/docs/latest/quickstart/ccd/aws-marketplace/byol"},next:{title:"Advanced Configuration",permalink:"/docs/latest/quickstart/ccd/aws-marketplace/advanced"}},s={},p=[{value:"Step 1: Follow along with the general steps for Customer Cloud Deployment",id:"step-1-follow-along-with-the-general-steps-for-customer-cloud-deployment",level:2},{value:"Step 2: Setup a Kubernetes cluster with AWS EKS",id:"step-2-setup-a-kubernetes-cluster-with-aws-eks",level:2},{value:"Step 3: Setup your STRM Privacy Data Plane",id:"step-3-setup-your-strm-privacy-data-plane",level:2},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Pricing",id:"pricing",level:2},{value:"Wrap-up",id:"wrap-up",level:2}],c={toc:p},m="wrapper";function u(e){let{components:t,...o}=e;return(0,r.kt)(m,(0,n.Z)({},c,o,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"This section describes how to get up and running with a Customer Cloud Deployment through the AWS Marketplace."),(0,r.kt)("admonition",{type:"tip"},(0,r.kt)("p",{parentName:"admonition"},"Try out the STRM Privacy - Pay As You Go AWS Marketplace Installation for free for 7 days, with 10 containers.\nSee the ",(0,r.kt)("a",{parentName:"p",href:"#pricing"},"pricing")," section for more details.")),(0,r.kt)("h2",{id:"step-1-follow-along-with-the-general-steps-for-customer-cloud-deployment"},"Step 1: Follow along with the general steps for Customer Cloud Deployment"),(0,r.kt)("p",null,"Before you can launch your AWS Marketplace STRM Privacy - Pay As You Go Installation, you need to follow along\nwith ",(0,r.kt)("a",{parentName:"p",href:"/docs/latest/quickstart/ccd/pre-requisites#step1"},"step 1"),"\nand ",(0,r.kt)("a",{parentName:"p",href:"/docs/latest/quickstart/ccd/pre-requisites#step2"},"step 2"),"\nfrom the prerequisites section."),(0,r.kt)("p",null,"Additionally, to the tools mentioned in ",(0,r.kt)("a",{parentName:"p",href:"/docs/latest/quickstart/ccd/pre-requisites#step2"},"step 2"),", you'll need to\ninstall:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://eksctl.io/"},(0,r.kt)("inlineCode",{parentName:"a"},"eksctl")),": a CLI to easily manage EKS clusters (unifies a lot of ",(0,r.kt)("inlineCode",{parentName:"li"},"aws")," CLI and ",(0,r.kt)("inlineCode",{parentName:"li"},"kubectl"),"\ncommands).")),(0,r.kt)("h2",{id:"step-2-setup-a-kubernetes-cluster-with-aws-eks"},"Step 2: Setup a Kubernetes cluster with AWS EKS"),(0,r.kt)("p",null,"One of the pre-requisites for the STRM Privacy Data Plane is an operational Kubernetes cluster. If you don't have an EKS\ncluster yet, please follow the instructions on how to setup an EKS cluster in\nthe ",(0,r.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/eks/latest/userguide/create-cluster.html"},"AWS EKS getting started guide"),"."),(0,r.kt)("admonition",{type:"important"},(0,r.kt)("p",{parentName:"admonition"},"Ensure that the EKS cluster you create, is ",(0,r.kt)("u",null,(0,r.kt)("strong",{parentName:"p"},"not"))," a Fargate EKS cluster as that is not supported by the Data\nPlane.")),(0,r.kt)("h2",{id:"step-3-setup-your-strm-privacy-data-plane"},"Step 3: Setup your STRM Privacy Data Plane"),(0,r.kt)("p",null,"Navigate to the ",(0,r.kt)("a",{parentName:"p",href:"https://aws.amazon.com/marketplace/pp/prodview-o3kfnl2luctxe"},"STRM Privacy AWS Marketplace")," listing and\nfollow the following steps."),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"AWS Marketplace",src:a(9372).Z,width:"2412",height:"1896"})),(0,r.kt)("admonition",{type:"tip"},(0,r.kt)("p",{parentName:"admonition"},"If you are working with different AWS profiles, don't forget to\nadd the ",(0,r.kt)("inlineCode",{parentName:"p"},"--profile your_profile")," flag to the ",(0,r.kt)("inlineCode",{parentName:"p"},"aws")," commands in the code blocks below.")),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"Subscribe"),(0,r.kt)("br",{parentName:"p"}),"\n","Click ",(0,r.kt)("inlineCode",{parentName:"p"},"Continue to Subscribe"),", and then ",(0,r.kt)("inlineCode",{parentName:"p"},"Accept license")," to start your subscription. ",(0,r.kt)("strong",{parentName:"p"},"Don't")," click ",(0,r.kt)("inlineCode",{parentName:"p"},"Continue to the Configuration"),", but follow along with the steps below."),(0,r.kt)("admonition",{parentName:"li",type:"important"},(0,r.kt)("p",{parentName:"admonition"},"The installation instructions in the AWS Marketplace after subscribing are quite unclear, as many details are left\nout.\nPlease follow along with this guide to help you setup your Data Plane via the AWS Marketplace"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"Create an OIDC provider"),(0,r.kt)("br",{parentName:"p"}),"\n","If your EKS cluster does not have an OIDC provider, one needs to be created. This is a requirement, as it is needed\nfor applications to call AWS Services on your behalf. This is limited to the services defined in a role by you in\nthis guide."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash",metastring:"placeholders cluster=EKS Cluster Name, region=EKS Cluster Region",placeholders:!0,cluster:"EKS",Cluster:!0,"Name,":!0,region:"EKS",Region:!0}," oidc_id=$(aws eks describe-cluster --name $cluster --query \"cluster.identity.oidc.issuer\" --output text --region $region | cut -d '/' -f 5)\n\n # Check if already present in account, if this returns nothing, proceed with the associate step\n # otherwise, an OIDC provider is already associated and this can be skipped\n aws iam list-open-id-connect-providers --region $region | grep $oidc_id\n\n # Associate the cluster with the OIDC provider\n $ eksctl utils associate-iam-oidc-provider --cluster $cluster --region $region --approve\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"Create AWS Marketplace Metering Role"),(0,r.kt)("br",{parentName:"p"}),"\n","In order for the STRM Privacy Data Plane applications to bill via your AWS invoice, the applications need to be able\nto call the AWS Marketplace Metering API. Therefore, a role needs to be created that allows web identities that have\nauthenticated via the OIDC provider, to assume this role."),(0,r.kt)("ol",{parentName:"li"},(0,r.kt)("li",{parentName:"ol"},"Create an assume role policy document. Fill out the placeholders below and download the file.",(0,r.kt)("admonition",{parentName:"li",type:"tip"},(0,r.kt)("p",{parentName:"admonition"},"Get the OIDC ID with the oneliner used in the previous step.")),(0,r.kt)("admonition",{parentName:"li",type:"tip"},(0,r.kt)("p",{parentName:"admonition"},"Get your AWS account id with this oneliner:"),(0,r.kt)("pre",{parentName:"admonition"},(0,r.kt)("code",{parentName:"pre"},'aws sts get-caller-identity --query "Account" --output text\n'))),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-json",metastring:"title=strmprivacy-marketplace-role.json download=strmprivacy-marketplace-role.json placeholders account_id=AWS (EKS) Account ID, region=EKS Region, oidc_id=OIDC ID, namespace=Kubernetes Namespace for STRM Privacy",title:"strmprivacy-marketplace-role.json",download:"strmprivacy-marketplace-role.json",placeholders:!0,account_id:"AWS","(EKS)":!0,Account:!0,"ID,":!0,region:"EKS","Region,":!0,oidc_id:"OIDC",namespace:"Kubernetes",Namespace:!0,for:!0,STRM:!0,Privacy:!0},'{\n  "Version": "2012-10-17",\n  "Statement": [\n    {\n      "Effect": "Allow",\n      "Principal": {\n        "Federated": "arn:aws:iam::$account_id:oidc-provider/oidc.eks.$region.amazonaws.com/id/$oidc_id"\n      },\n      "Action": "sts:AssumeRoleWithWebIdentity",\n      "Condition": {\n        "StringLike": {\n          "oidc.eks.$region.amazonaws.com/id/$oidc_id:sub": "system:serviceaccount:$namespace:*"\n        }\n      }\n    }\n  ]\n}\n'))),(0,r.kt)("li",{parentName:"ol"},"Create the role.",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell",metastring:"placeholders role_name=Name of the role",placeholders:!0,role_name:"Name",of:!0,the:!0,role:!0},'aws iam create-role --role-name $role_name --assume-role-policy-document "file:///path/to/strmprivacy-marketplace-role.json"\n'))),(0,r.kt)("li",{parentName:"ol"},"Attach the ",(0,r.kt)("inlineCode",{parentName:"li"},"AWSMarketplaceMeteringRegisterUsage")," predefined policy by AWS",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell",metastring:"placeholders role_name=Name of the role",placeholders:!0,role_name:"Name",of:!0,the:!0,role:!0},"aws iam attach-role-policy --policy-arn arn:aws:iam::aws:policy/AWSMarketplaceMeteringRegisterUsage --role-name $role_name\n"))),(0,r.kt)("li",{parentName:"ol"},"Get the Role ARN:",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell",metastring:"placeholders role_name=Name of the role",placeholders:!0,role_name:"Name",of:!0,the:!0,role:!0},"aws iam get-role --role-name $role_name | jq -r '.Role.Arn'\n"))))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"Install\nthe")," ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/strmprivacy/data-plane-helm-chart"},(0,r.kt)("img",{parentName:"a",src:"https://img.shields.io/github/v/release/strmprivacy/data-plane-helm-chart?label=Data%20Plane%20Helm%20Chart#img-shield-vertical-align",alt:"data-plane-version"})),(0,r.kt)("br",{parentName:"p"}),"\n","Run the following commands shown in the script below."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell",metastring:"showLineNumbers placeholders version=https://api.github.com/repos/strmprivacy/data-plane-helm-chart/releases/latest#name, installation_id=Installation ID, client_id=Client ID of your installation, client_secret=Client Secret of your installation, role_arn=ARN of the role created in the previous step, namespace=Kubernetes Namespace",showLineNumbers:!0,placeholders:!0,version:"https://api.github.com/repos/strmprivacy/data-plane-helm-chart/releases/latest#name,",installation_id:"Installation","ID,":!0,client_id:"Client",ID:!0,of:!0,your:!0,"installation,":!0,client_secret:"Client",Secret:!0,role_arn:"ARN",the:!0,role:!0,created:!0,in:!0,previous:!0,"step,":!0,namespace:"Kubernetes",Namespace:!0},'# Enables using Helm Charts in Open Container Image format\nexport HELM_EXPERIMENTAL_OCI=1\n\n# Region us-east-1 is required as the AWS Marketplace ECR registries are located there\naws ecr get-login-password \\\n--region us-east-1 | helm registry login \\\n--username AWS \\\n--password-stdin 709825985650.dkr.ecr.us-east-1.amazonaws.com\n\n# Create a temporary working directory to download the chart to and install it\nmkdir awsmp-chart && cd awsmp-chart\n\n# Pull the latest Helm Chart Version: $version\nhelm pull oci://709825985650.dkr.ecr.us-east-1.amazonaws.com/strm-privacy/strm-payg --version $version\n\n# Untar the chart and remove the tarball\ntar xf $(pwd)/* && find $(pwd) -maxdepth 1 -type f -delete\n\n# Install the chart\n// callout-1\nhelm install strmprivacy \\\n// callout-2\n--namespace $namespace --create-namespace ./* \\\n// callout-3\n--set license.installationType=AWS_MARKETPLACE_PAYG \\\n--set license.installationId=$installation_id \\\n--set license.installationClientId=$client_id \\\n--set license.installationClientSecret=$client_secret \\\n--set marketplace.aws.serviceAccountRoleArn="$role_arn"\n')),(0,r.kt)("p",{parentName:"li"},"Replace the placeholders above with the values that can be found in your\n",(0,r.kt)("a",{parentName:"p",href:"https://console.strmprivacy.io/installation/configuration"},"installation configuration"),". In the ",(0,r.kt)("inlineCode",{parentName:"p"},"helm install"),"\ncommand\nabove, the following remarks apply:",(0,r.kt)("br",{parentName:"p"}),"\n","1","."," The name of the installed Helm Chart (how the installation will show up in the ",(0,r.kt)("inlineCode",{parentName:"p"},"helm list")," command).",(0,r.kt)("br",{parentName:"p"}),"\n","2","."," The Kubernetes namespace to which the Helm Chart will be installed.",(0,r.kt)("br",{parentName:"p"}),"\n","3","."," The ",(0,r.kt)("inlineCode",{parentName:"p"},"installationType"),", that indicates that this is a AWS Marketplace BYOL installation."),(0,r.kt)("p",{parentName:"li"},"Feel free to change the value for the name of the Helm Chart (1) and the Kubernetes namespace (2).")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"Wait until the installation finishes"),(0,r.kt)("br",{parentName:"p"}),"\n","As by default, the embedded Kafka, Redis, and Postgres Database are included, installation can take a moment. After\ninstallation, you should end up with a namespace that contains all components that were enabled as specified in the\n",(0,r.kt)("inlineCode",{parentName:"p"},"values.yaml")," (here ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/strmprivacy/data-plane-helm-chart/blob/master/helm/values.yaml"},"the defaults"),"\nare used, as they're not overridden)."))),(0,r.kt)("p",null,"After these steps, you should end up with a namespace ",(0,r.kt)("inlineCode",{parentName:"p"},"strmprivacy")," with, by\ndefault, ",(0,r.kt)("a",{parentName:"p",href:"/docs/latest/quickstart/ccd/#components"},"all components")," enabled. If you\nwish otherwise, you can edit the ",(0,r.kt)("inlineCode",{parentName:"p"},"values.yaml")," to match your needs."),(0,r.kt)("admonition",{type:"important"},(0,r.kt)("p",{parentName:"admonition"},"Even though the example above uses ",(0,r.kt)("inlineCode",{parentName:"p"},"--set")," in the ",(0,r.kt)("inlineCode",{parentName:"p"},"helm install")," command, prefer using a ",(0,r.kt)("inlineCode",{parentName:"p"},"values.yaml"),". More details\ncan be found ",(0,r.kt)("a",{parentName:"p",href:"/docs/latest/quickstart/ccd/aws-marketplace/advanced#using-a-valuesyaml"},"here"),".")),(0,r.kt)("h2",{id:"troubleshooting"},"Troubleshooting"),(0,r.kt)("p",null,"The metering process in the AWS Marketplace is quite complex, and errors can occur. Here are some issues that can be\nencountered while setting up the STRM Privacy Data Plane - Pay As You Go variant:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Missing policy"),": attach the policy ",(0,r.kt)("inlineCode",{parentName:"li"},"AWSMarketplaceMeteringRegisterUsage")," to the role created for the Data Plane. ",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"User: arn:aws:sts::<account_id>:assumed-role/... is not authorized to perform: aws-marketplace:RegisterUsage because\nno identity-based policy allows the aws-marketplace:RegisterUsage action (Service: MarketplaceMetering,\nStatus Code: 400, Request ID: <uuid>)\n")))),(0,r.kt)("p",null,"Issue not listed here? Please ",(0,r.kt)("a",{parentName:"p",href:"/docs/latest/contact/"},"contact us")," to get support."),(0,r.kt)("h2",{id:"pricing"},"Pricing"),(0,r.kt)("p",null,"With Pay As You Go, you only pay for the containers that are running. If you don't need a component, you can easily\ndisable it through the ",(0,r.kt)("inlineCode",{parentName:"p"},"values.yaml"),". All running containers have a fixed price per hour of ",(0,r.kt)("inlineCode",{parentName:"p"},"$0.20"),". Therefore, if you'd\nrun all components in your Data Plane, and would have:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"1 stream, with 3 derived streams"),(0,r.kt)("li",{parentName:"ul"},"1 batch exporter")),(0,r.kt)("p",null,"The price per hour would be:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Enabled components (Event Gateway, Web Socket, Batch Jobs Agent, Batch Exporters Agent, Streams Agent): ",(0,r.kt)("inlineCode",{parentName:"li"},"$1.00")),(0,r.kt)("li",{parentName:"ul"},"3 derived streams = 1 decrypter: ",(0,r.kt)("inlineCode",{parentName:"li"},"$0.20")),(0,r.kt)("li",{parentName:"ul"},"1 batch exporter: ",(0,r.kt)("inlineCode",{parentName:"li"},"$0.20"))),(0,r.kt)("p",null,"Which is a total of ",(0,r.kt)("inlineCode",{parentName:"p"},"$1.40")," / hour. For more details on pricing, please ",(0,r.kt)("a",{parentName:"p",href:"/docs/latest/contact/"},"contact us"),"."),(0,r.kt)("h2",{id:"wrap-up"},"Wrap-up"),(0,r.kt)("p",null,"You've installed a STRM Privacy Data Plane via the AWS Marketplace. If you have had any issues during your\ninstallation, please let us know, or create a pull request on GitHub to improve these docs."),(0,r.kt)("p",null,"Now that you are done with the setup, follow the docs\non ",(0,r.kt)("a",{parentName:"p",href:"/docs/latest/quickstart/ccd/interacting"},"how to interact with your cluster")," to start\nusing it."))}u.isMDXComponent=!0},9372:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/payg-ac554924e788427c0774a1ad2c39b0d2.png"}}]);
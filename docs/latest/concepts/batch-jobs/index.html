<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.16">
<link rel="search" type="application/opensearchdescription+xml" title="STRM Privacy Documentation" href="/opensearch.xml">
<script src="https://plausible.io/js/plausible.js" defer="defer" data-domain="docs.strmprivacy.io"></script><title data-rh="true">Batch Jobs | STRM Privacy Documentation</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://docs.strmprivacy.io//docs/latest/concepts/batch-jobs/"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Batch Jobs | STRM Privacy Documentation"><meta data-rh="true" name="description" content="This page describes the most important concepts to understand when using"><meta data-rh="true" property="og:description" content="This page describes the most important concepts to understand when using"><link data-rh="true" rel="icon" href="/img/favicon.svg"><link data-rh="true" rel="canonical" href="https://docs.strmprivacy.io//docs/latest/concepts/batch-jobs/"><link data-rh="true" rel="alternate" href="https://docs.strmprivacy.io//docs/latest/concepts/batch-jobs/" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.strmprivacy.io//docs/latest/concepts/batch-jobs/" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://M24OHV52F0-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.f509ff92.css">
<link rel="preload" href="/assets/js/runtime~main.8129c0b7.js" as="script">
<link rel="preload" href="/assets/js/main.b1046291.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://strmprivacy.io" target="_self" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="https://storage.googleapis.com/strm-media/strm-logo-orange-slim.svg" alt="STRM Privacy Logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="https://storage.googleapis.com/strm-media/strm-logo-orange-slim.svg" alt="STRM Privacy Logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div></a><a class="navbar__item navbar__link navbar__link--active" href="/docs/latest/overview/about/">Docs</a><a href="https://join.strm.team/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Hiring!</a></div><div class="navbar__items navbar__items--right"><div class="toggle_Pssr toggle_TdHA toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">üåú</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">üåû</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode (currently light mode)"></div><div class="searchBox_qEbK"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_CW9Y"><nav class="menu thin-scrollbar menu_SkdO"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link" href="/docs/latest/overview/">Overview</a><button aria-label="Toggle the collapsible sidebar category &#x27;Overview&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--active" href="/docs/latest/concepts/">Concepts</a><button aria-label="Toggle the collapsible sidebar category &#x27;Concepts&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/latest/concepts/core-concepts/">Core</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/latest/concepts/batch-vs-streaming/">Batch vs Stream processing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/latest/concepts/batch-jobs/">Batch Jobs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/latest/concepts/schemas-and-contracts/">Schemas and Contracts</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/latest/concepts/strm-meta/">the strmMeta section</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/latest/concepts/masked-fields/">Masked Fields</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/latest/concepts/simple-schemas/">Simple Schemas</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link" href="/docs/latest/quickstart/">Quickstart</a><button aria-label="Toggle the collapsible sidebar category &#x27;Quickstart&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link" href="/docs/latest/cli-index/">CLI Reference</a><button aria-label="Toggle the collapsible sidebar category &#x27;CLI Reference&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/latest/contact/">Contact</a></li></ul></nav></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Xlws" aria-label="breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a class="breadcrumbs__link breadcrumbsItemLink_e5ie" href="/">üè†</a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link breadcrumbsItemLink_e5ie" href="/docs/latest/concepts/">Concepts</a></li><li class="breadcrumbs__item breadcrumbs__item--active"><a class="breadcrumbs__link breadcrumbsItemLink_e5ie" href="/docs/latest/concepts/batch-jobs/">Batch Jobs</a></li></ul></nav><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Batch Jobs</h1></header><p>This page describes the most important concepts to understand when using
Batch Jobs.</p><h1>Batch Job Concepts</h1><h2 class="anchor anchorWithStickyNavbar_mojV" id="a-batch-job">A Batch Job<a class="hash-link" href="#a-batch-job" title="Direct link to heading">‚Äã</a></h2><p>STRM supports batch processing through Batch Jobs. One Batch Job
represents the processing of one data file: encryption, decrypion,
masking and exporting the results. This means that a Batch Job has a
finite lifetime after it starts. It either succeeds or it fails, it‚Äôs
not a continuously running process, like a Kafka consumer or a Batch
Exporter.</p><p>Processing multiple files thus requires multiple Batch Jobs and a Batch
Job cannot be reinstantiated for a second run.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="encryption">Encryption<a class="hash-link" href="#encryption" title="Direct link to heading">‚Äã</a></h2><p>A lot in STRM processing, both batch and streaming, revolves around
encryption of data. While most of it is the same, there are subtle
differences between how data is encrypted between the two, mostly
related to timing.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="encryption-keys">Encryption keys<a class="hash-link" href="#encryption-keys" title="Direct link to heading">‚Äã</a></h3><p>When using streams, encryption keys are generated on-the-fly when there
is no existing key for the given key field value. These encryption keys
then have a lifetime of 24 hours, after which a new encryption key is
generated when an event comes in.</p><p>So this process relies on the current time.</p><p>When relying on the current time while processing a batch of data, two
things can happen:</p><ul><li><p>A big batch of data contains records that are more than 24 hours
apart. This causes too much data to be encrypted using the same
encryption key, which is undesirable.</p></li><li><p>A batch contains data with records that are less than 24 hours
apart. This causes encryption keys to be rotated too often, making
it hard to &quot;link&quot; associated data, like a user session.</p></li></ul><p>These two statements assume that a Batch Job takes less than 24 hours,
which is the common case.</p><p>In either case, the current time is not usable with batch processing.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="the-importance-of-timestamps">The importance of timestamps<a class="hash-link" href="#the-importance-of-timestamps" title="Direct link to heading">‚Äã</a></h3><p>Because we cannot use the current time, and the timestamp is mandatory,
we require a timestamp to be present in every record.</p><p>This timestamp can then be used to determine which encryption key is
used when encrypting the PII fields in this record.</p><p>For determining the encryption key, we persistently store all encryption
keys in a database, along with a time window in which the key is valid.
Just as with streaming, this window is 24 hours.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="batch-job-groups">Batch Job Groups<a class="hash-link" href="#batch-job-groups" title="Direct link to heading">‚Äã</a></h3><p>Batch Jobs can be configured to be part of the same &quot;group&quot;. This means
that these Batch Jobs use the same set of encryption keys. This can be
very helpful when the same dataset is split across multiple files and/or
you‚Äôd like to have a fluent transition at time window boundaries.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="data-connectors">Data Connectors<a class="hash-link" href="#data-connectors" title="Direct link to heading">‚Äã</a></h2><p>A Batch Job reads data from and sends data to a Data Connector. Because
of historic reasons, Data Connector is also called Sink, but we‚Äôre
planning to move away from the name Sink as for most people it means a
place to send data to, and not read from..</p><p>For now, we only support AWS S3 Data Connectors, but Google Cloud
Storage buckets are next in line.</p><p>For a Batch Job, three or more Data Connectors need to be specified,
for:</p><ul><li><p>The location of the source data (from where is the unencrypted data
read?).</p></li><li><p>The location of the encrypted data (where is the encrypted data
stored?).</p></li><li><p>The location of the encryption keys (where are the encrypted keys
stored?).</p></li><li><p>Zero or more locations for the derived data (where is every file
with derived data stored?)</p></li></ul><p>Having separate Data Connectors for each piece of input/output data
makes it possible to create data pipelines that are inherently safe,
because consumers only see the data they‚Äôre allowed to see. But of
course it‚Äôs also possible to reuse the same Data Connector.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="consent">Consent<a class="hash-link" href="#consent" title="Direct link to heading">‚Äã</a></h2><p>Just like with streaming, a lot of our processing relies on consent; the
consent of the end user (i.e. the visitor on the website) and the
consent we‚Äôd like to have decrypted.</p><p>For this, we need every record or event to have the consent of the end
user. Without consent, we can only use encrypted PII fields.</p><p>To fit into as many environments as possible, we provide a mechanism to
extract the consent from the source data.</p><p>First you need to specify which field contains the consent.</p><ul><li><p>Then you can create a mapping to translate between your terminology
and our consent levels, which are integer arrays. A mapping could
be: Map &quot;analytics&quot; to &quot;<!-- -->[<!-- -->1,2<!-- -->]<!-- -->&quot;.</p></li><li><p>If no mapping is specified, we try to parse the data as an int
array, like this: &quot;<!-- -->[<!-- -->1,2<!-- -->]<!-- -->&quot; or as an int, like this: &quot;1&quot;.</p></li><li><p>If there is no mapping, the data is not an int or int array, or if
there is another error while parsing, the provided default is used.
Typically this is an empty list, meaning &quot;no consent&quot; or &quot;unknown&quot;.</p></li></ul><p>We‚Äôre planning on more ways to extract consent, like user-provided code,
but this is not planned for the near future.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="batch-job-states">Batch Job states<a class="hash-link" href="#batch-job-states" title="Direct link to heading">‚Äã</a></h2><p>Success flow:</p><ol><li><p>The Batch Job has a finite lifetime. When created, it has the
status: &quot;PENDING&quot;. This means it has been successfully created and
will be started soon.</p></li><li><p>When the Batch Job is started it gets the status: &quot;STARTED&quot;. This
means all Data Connectors have been initialized, and it is about to
read the source data.</p></li><li><p>While the Batch Job is running, it has the status: &quot;RUNNING&quot; every
10 seconds.</p></li><li><p>When it‚Äôs done and all files have been uploaded to the respective
Data Connectors, it has the status &quot;FINISHED&quot;.</p></li></ol><p>Error states:</p><ol><li><p>When there is an error starting the Batch Job, it gets the status:
&quot;ERROR<!-- -->_<!-- -->STARTING&quot;. We retry restarting it for three times, after
which we consider it an unrecoverable error, and we stop trying.</p></li><li><p>When there is an error while running the Batch Job, for example,
while processing a CSV or writing to a Data Connector, it gets the
status: &quot;ERROR&quot;. We consider this an unrecoverable error, and we
don‚Äôt retry.</p></li></ol></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/latest/concepts/batch-vs-streaming/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Batch vs Stream processing</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/latest/concepts/schemas-and-contracts/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Schemas and Contracts</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#a-batch-job" class="table-of-contents__link toc-highlight">A Batch Job</a></li><li><a href="#encryption" class="table-of-contents__link toc-highlight">Encryption</a><ul><li><a href="#encryption-keys" class="table-of-contents__link toc-highlight">Encryption keys</a></li><li><a href="#the-importance-of-timestamps" class="table-of-contents__link toc-highlight">The importance of timestamps</a></li><li><a href="#batch-job-groups" class="table-of-contents__link toc-highlight">Batch Job Groups</a></li></ul></li><li><a href="#data-connectors" class="table-of-contents__link toc-highlight">Data Connectors</a></li><li><a href="#consent" class="table-of-contents__link toc-highlight">Consent</a></li><li><a href="#batch-job-states" class="table-of-contents__link toc-highlight">Batch Job states</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright (C) 2020-2022 STRM Privacy</div></div></div></footer></div>
<script src="/assets/js/runtime~main.8129c0b7.js"></script>
<script src="/assets/js/main.b1046291.js"></script>
</body>
</html>